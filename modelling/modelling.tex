\graphicspath{{modelling/fig/}}
{
\tikzset{external/figure name/.add={modelling/}{}}

\chapter{Modelling}
\label{chap:modelling}

\paragraph
In this chapter, mathematical models of a multirotor with a suspended payload will be derived.
These models will be used to simulate the multirotor system in subsequent chapters.
The models will be based on the real multirotor named \emph{Honeybee}, which was built by \cite{Grobler2020} and will be described further in Chapter~\ref{chap:exp_design}.

% ?? Write this section

\paragraph
Firstly, 
quadrotor modelled separately
payload modelled separately
% The system identification and control system techniques in later chapters will then be explained based on the \gls{2D} model to avoid unnecessary complexity.
Finally, it will be described how this model and the techniques in later chapters are extended to the 3D case.
This 3D mathematical model will be used in a non-linear simulation of a multirotor and suspended payload.

% ?? For good modelling of multirotor, survey: https://arxiv.org/pdf/2011.11104.pdf

\FloatBarrier\section{Coordinate frames}

    \paragraph
    A quadrotor with a standard X-configuration is considered in this work.
    Figure~\ref{fig:coord_frames} shows a quadrotor schematic and two coordinate frames that will be used to describe this system.
    
    \begin{figure}[htb]
        \centering
        \includegraphics[width=0.6\linewidth]{modelling/fig/coord_frames}
        \caption{Inertial and body coordinate frames of a quadrotor from \cite{Erasmus2020}}
        \label{fig:coord_frames}
    \end{figure}

    \paragraph
    The inertial frame is denote by $ \mathcal{I} = \{ \bm{\bar{x}}_\mathcal{I}, \bm{\bar{y}}_\mathcal{I}, \bm{\bar{z}}_\mathcal{I} \} $ and describes a \gls{NED} axis system.
    The $x$, $y$, and $z$ axis, align with the North, East, and Down inertial directions respectively.
    The inertial frame assumes a flat, non-rotating earth, since the quadrotor will travel small distances in comparison to the curvature of the earth.
    The origin of this frame is fixed at the takeoff location of the multirotor.

    \paragraph
    The body frame is denote by $ \mathcal{B} = \{ \bm{\bar{x}}_\mathcal{B}, \bm{\bar{y}}_\mathcal{B}, \bm{\bar{z}}_\mathcal{B} \} $ and is fixed to the quadrotor body.
    The origin of this frame is at the \gls{CoM} of the vehicle and the $x$, $y$, and $z$ axis, align with the forwards, rightwards, and downwards directions of the quadrotor body respectively.
    The body frame is defined by a translation and rotation relative to the inertial frame.
    The position of the \gls{CoM} of the multirotor in the inertial frame is denoted as $P = [P_N~~P_E~~P_D]^T$. 
    This represents the translation of the body frame relative to the inertial frame.
    The rotations will be discussed in the section below.

\FloatBarrier\section{Rotations}
    
    \paragraph
    The rotation of the body frame relative to the inertial frame is referred to as the attitude of the multirotor.
    Attitude will be defined in terms of Euler angles or quaternions in this work, which will be described below.

    \FloatBarrier\subsection{Euler angles}

        \paragraph
        Euler angles are a popular way of describing a \gls{3D} rotation as a sequence of three consecutive elementary rotations \cite{Brescianini2013}.
        For aircraft applications, the ZYX-sequence is common \cite{Brescianini2013} and will be used in this work.
        The order of rotations are:
        \begin{enumerate}
            \item Rotate the body frame about the $z$-axis by the yaw angle, $\Psi$.
            \item Rotate the resulting frame about the new $y$-axis by the pitch angle, $\Theta$.
            \item Rotate the resulting frame about the new $x$-axis by the roll angle, $\Phi$.
        \end{enumerate}

        \begin{figure}[!htbp]
            \centering
            \vspace{0.5cm}
            \def\svgwidth{\columnwidth}
            \scalebox{0.85}{\input{modelling/fig/Euler_rotations.pdf_tex}}
            \vspace{0.5cm}
            \caption{Illustration of Euler angles from \cite{Slabber2020}}
            \label{fig:Euler_rotations}
        \end{figure}

        \paragraph
        Figure~\ref{fig:Euler_rotations} gives a simple illustration of the Euler-ZYX angles.
        Note that $\Theta$ and $\Phi$ are each illustrated here as a pure pitch angle and roll angle from the the inertial frame, without a prior Euler rotation.

    \FloatBarrier\subsection{Quaternions}

        \paragraph
        A quaternion provides way of representing a rotation with four parameters.
        An advantage of quaternions is that it does not produce singularities like Euler angles do \cite{Brescianini2013}.
        A quaternion defines a rotation with a single rotation about a fixed axis, 
        which is parametrized by a rotation angle, $\alpha$, and a unit vector, $\vec{r}$.
        A unit quaternion is therefore defined as,
        \begin{equation}
            \bm{q} = [q_0~~q_1~~q_2~~q_3]^T = 
            \begin{bmatrix}
                q_0 \\ 
                \bm{q}_v
            \end{bmatrix}
            =
            \begin{bmatrix}
                \cos(\frac{\alpha}{2}) \\ 
                \vec{r} \sin(\frac{\alpha}{2} )
            \end{bmatrix} ,
        \end{equation}
        where $q_0$ is the magnitude component and $\bm{q}_v$ is the vector component of the quaternion.

        \paragraph
        A Euler-ZYX angle representation, $[\Theta~~\Phi~~\Psi]$, can be converted to a quaternion with the equation \cite{Brescianini2013},
        \begin{equation}
            \bm{q}(\Theta, \Phi, \Psi) = 
            \left[\begin{array}{c}
                \begin{aligned}%[t]
                     \cos{\tfrac{\Phi}{2}} \cos{\tfrac{\Theta}{2}}  \cos{\tfrac{\Psi}{2}}    ~~ &+ ~~ \sin{\tfrac{\Phi}{2}}   \sin{\tfrac{\Theta}{2}}  \sin{\tfrac{\Psi}{2}} \\
                    -\cos{\tfrac{\Phi}{2}} \sin{\tfrac{\Theta}{2}}  \sin{\tfrac{\Psi}{2}}    ~~ &+ ~~ \cos{\tfrac{\Theta}{2}} \cos{\tfrac{\Psi}{2}}    \sin{\tfrac{\Phi}{2}} \\
                     \cos{\tfrac{\Phi}{2}} \cos{\tfrac{\Psi}{2}}    \sin{\tfrac{\Theta}{2}}  ~~ &+ ~~ \sin{\tfrac{\Phi}{2}}   \cos{\tfrac{\Psi}{2}}    \sin{\tfrac{\Psi}{2}} \\
                     \cos{\tfrac{\Phi}{2}} \cos{\tfrac{\Theta}{2}}  \sin{\tfrac{\Psi}{2}}    ~~ &- ~~ \sin{\tfrac{\Phi}{2}}   \cos{\tfrac{\Psi}{2}}    \sin{\tfrac{\Theta}{2}} \\
                \end{aligned}
            \end{array}\right] .
        \end{equation}

        \paragraph
        The inverse of an quaternion is defined as,
        \begin{equation}
            \bm{q}^{-1} = 
            \frac{ \begin{bmatrix} q_0 \\ -\bm{q}_v \end{bmatrix} }{ \sqrt{ {q_{0}}^{2} + {q_{1}}^{2} + {q_{2}}^{2} + {q_{3}}^{2} } } .
        \end{equation}

        \paragraph
        Furthermore, the multiplication of two quaternions, $\bm{q}$ and $\bm{q}^\prime$, is given by \cite{Brescianini2013}:
        \begin{equation}
            \bm{q} \cdot \bm{q}^\prime
            =
            Q( \bm{q} ) \bm{q}^\prime,
        \end{equation}
        where
        \begin{equation}
            Q( \bm{q} ) = 
            \left[\begin{array}{cccc}
                q_{0} &           - q_{1} &           - q_{2} &           - q_{3} \\
                q_{1} & \phantom{-} q_{0} &           - q_{3} & \phantom{-} q_{2} \\
                q_{2} & \phantom{-} q_{3} & \phantom{-} q_{0} &           - q_{1} \\
                q_{3} &           - q_{2} & \phantom{-} q_{1} & \phantom{-} q_{0}
            \end{array}\right] .
        \end{equation}

        \paragraph
        These equations will be applied in subsequent chapters.

\FloatBarrier\section{Quadrotor model}

    \paragraph
    The quadrotor is modelled as a rigid body with six degrees of freedom.
    This includes three translations and three rotational degrees of freedom.
    This modelling process is also well described by \cite{Erasmus2020} and \cite{Slabber2020}, and the same general procedure is followed in this work. 
    
    \paragraph
    The system parameters describing the physical properties of the quadrotor is listed in Table~\ref{tbl:quadrotor_params}.
    These parameters will be used in subsequent sections to derive a model of the quadrotor.

    \begin{table}[!htbp]
        \renewcommand{\arraystretch}{1.1}
        \centering
        \caption{System parameters of the quadrotor model.}
        \begin{tabularx}{0.66\linewidth}{@{}ll@{}}
            \toprule
            \textbf{Symbol}   & \textbf{Description} \\
                $m_Q$       & Mass of multirotor \\
                $I_{xx}$    & Mass moment of inertia about $\bm{\bar{x}}_\mathcal{B}$ \\ 
                $I_{yy}$    & Mass moment of inertia about $\bm{\bar{y}}_\mathcal{B}$ \\ 
                $I_{zz}$    & Mass moment of inertia about $\bm{\bar{z}}_\mathcal{B}$ \\ 
                $d$         & Distance from \gls{CoM} to each motor\\
                $R_N$       & Virtual yaw moment arm \\
                $\tau$      & Motor time constant \\ 
                $C_{D_X}$   & Aerodynamic drag coefficient in $\bm{\bar{x}}_\mathcal{B}$ direction \\
                $C_{D_Y}$   & Aerodynamic drag coefficient in $\bm{\bar{x}}_\mathcal{B}$ direction \\
                $C_{D_Z}$   & Aerodynamic drag coefficient in $\bm{\bar{x}}_\mathcal{B}$ direction \\
            \bottomrule
        \end{tabularx}
        \label{tbl:quadrotor_params}
    \end{table}

    \paragraph
    The linear velocity of the quadrotor is denoted by,
    \begin{equation}
        \bm{V_\mathcal{B}} = 
        \begin{bmatrix}
            V_{\mathcal{B}_X} & V_{\mathcal{B}_Y} & V_{\mathcal{B}_Z}\\
        \end{bmatrix}^T
    \end{equation}
    and the angular velocity is denoted by,
    \begin{equation}
        \bm{\varOmega_\mathcal{B}} = 
        \begin{bmatrix}
            \varOmega_{\mathcal{B}_X} & \varOmega_{\mathcal{B}_Y} & \varOmega_{\mathcal{B}_Z}\\
        \end{bmatrix}^T.
    \end{equation}
    with respect to the body frame.

    \paragraph
    Applying Newton's second law, the rigid body equations of motion is derived as:
    \begin{align}
        \bm{F_\mathcal{B}} & = m_Q\bm{\dot{V}_\mathcal{B}} + \bm{\varOmega_\mathcal{B}} \times m_Q\bm{V_\mathcal{B}} , \label{eq:forces} \\ 
        \bm{M_\mathcal{B}} & = \bm{I_Q}\bm{\dot{\varOmega}_\mathcal{B}} + \bm{\varOmega_\mathcal{B}} \times  \bm{I_Q}\bm{V_\mathcal{B}} , \label{eq:body_rates}
    \end{align}
    where 
    \begin{align}
        \bm{F_\mathcal{B}} = &
        \begin{bmatrix}
            %F_{\mathcal{B}_X} & F_{\mathcal{B}_Y} & F_{\mathcal{B}_Z}\\
            X & Y & Z\\
        \end{bmatrix}^T , \\
            \bm{M_\mathcal{B}} = &
        \begin{bmatrix}
            %M_{\mathcal{B}_X} & M_{\mathcal{B}_Y} & M_{\mathcal{B}_Z}\\
            L & M & N
        \end{bmatrix}^T ,
    \end{align}
    are the forces and moments, respectively, acting on the quadrotor, with respect to the body frame.
    The inertia tensor of the quadrotor is defined as,
    \begin{equation} \label{eq:inertia}
        \bm{I_Q} = 
        \begin{bmatrix}
            I_{xx} & I_{xy} & I_{xz}\\
            I_{yx} & I_{yy} & I_{yz}\\
            I_{zx} & I_{zy} & I_{zz}
        \end{bmatrix}
        \approx
        \begin{bmatrix}
            I_{xx} & 0 & 0\\
            0 & I_{yy} & 0\\
            0 & 0 & I_{zz}
        \end{bmatrix}.
    \end{equation}
    The quadrotor is assumed to be symmetrical about the $XZ$- and $YZ$-plane, therefore the inertia tensor can be approximated as a diagonal matrix as shown in Equation~\ref{eq:inertia}. 

\FloatBarrier\section{Suspended payload model}

    \paragraph
    The suspended payload is modelled as a rigid body attached by a link to the \gls{CoM} of the quadrotor rigid body.
    Figure~\ref{fig:quad_payload} illustrates a quadrotor with a suspended payload and the Euler-ZYX angles of the suspended payload in the inertial frame are also shown.
    The $x$-axis and $y$-axis Euler angles are denoted by $\theta_p$ and $\phi_p$ respectively.
    The $z$-axis Euler angle does not contribute to the system dynamics and is omitted. 

    \begin{figure}[!htbp]
        \centering
        \def\svgwidth{\columnwidth}
        \scalebox{0.6}{\input{modelling/fig/quad_payload.pdf_tex}}
        \caption{Schematic of a quadrotor with suspended payload from \cite{Slabber2020}}
        \label{fig:quad_payload}
    \end{figure}
    
    \paragraph
    The following assumptions are made regarding the payload model:
    \begin{itemize}
        \item The payload is a point mass.
        \item The link is massless.
        \item The link is rigid.
        \item The link is attached to the \gls{CoM} of the multirotor.
    \end{itemize}

    \paragraph
    The payloads used in the practical setup and described in Chapter~\ref{chap:exp_design}, 
    are small relative to the quadrotor and the attachment point is close to the payload \gls{CoM}.
    They are attached with a low-friction swivel to the suspended cable, therefore the rotation of the payload around the cable axis has a negligible effect on the quadrotor. 
    Therefore modelling a payload as a point mass seems reasonable.

    \paragraph
    The cables used in Chapter~\ref{chap:exp_design} have a very low mass in comparison to the payloads and have a negligible amount of stretch.
    Furthermore, the cable remains straight and rigid during flight due to the tension applied by the payload.
    Aggressive flights may cause periods of zero cable tension where the load is in free-fall and the cable is slack \cite{Tang2015}.
    However, such aggressive manoeuvres will not be considered in this work and the assumption of a rigid, massless cable appears reasonable.

    \paragraph
    In the practical setup shown in Chapter~\ref{chap:exp_design}, the cable is attached appears to be very near to the \gls{CoM} of the quadrotor.
    It is assumed that if the attachment point is slightly below this point it will have a negligible effect on the dynamics.

\FloatBarrier\section{Forces and moments}

    \paragraph
    damping of payload angle


\FloatBarrier\section{Lagrangian mechanics}
    \begin{enumerate}
        \item Discuss weak link between altitude dynamics and swing angle
    \end{enumerate}


\FloatBarrier\section{Model verification} \label{sec:model_verification}

    \paragraph
    Intro

    \input{modelling/plots/prac_vs_sim_vel_step_no_payload.tex}

    \paragraph
    No load

    \input{modelling/plots/prac_vs_sim_vel_step_with_payload.tex}

    \paragraph
    With payload vel

    \input{modelling/plots/prac_vs_sim_theta_with_payload.tex}

    \paragraph
    With payload theta



    \begin{enumerate}
        \item Plot velocity step
        \item Plot position step
    \end{enumerate}

\FloatBarrier\section{Linearised model}
    \label{sec:linear_model}

\FloatBarrier\section{Dynamic payloads}

    In this work, a dynamic payload refers to a payload with dynamics that differ significantly from a rigid mass.
    When considering suspended payloads, a dynamic payload induces dynamics which differ from that of a simple pendulum.

    \begin{itemize}
        \item Most control in literature model payload as rigid Mass. Give references.
        \item Some add spring stiffness of cable (give references e.g. QuadLoad ElasticCable Prasanth Kotaru)
        \item but not practical because can design which cable you used. Cannot design which payload needs to be transported
        \item water looks like double payload
    \end{itemize}
% https://hybrid-robotics.berkeley.edu/publications/ACC2017_QuadLoad_ElasticCable.pdf), 
% https://www.researchgate.net/publication/352394086_A_Hybrid_Control_Approach_for_the_Sw[â€¦]=publicationTitle&_iepl%5BtargetEntityId%5D=PB%3A352394086

}

