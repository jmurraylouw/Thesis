\graphicspath{{results/fig/}}

\chapter{Implementation and results}
\label{chap:results}

    \paragraph
    In previous chapters it was shown with simulation data that both the white-box and black-box system identifcation techniques
    accurately represent the dynamics of a multirotor with a suspended payload.
    However, practical flights may differ significantly from simulations, which may affect the performance of these techniques.
    For example, wind causes an unmeasured disturbance which influences the flight of a multirotor, 
    but was not considered during simulation.
    Wind disturbance involves randomly fluctuating forces 
    which are applied to the vehicle, payload and cable.
    It is also very difficult to model these forces accurately and determine accurate drag coefficients of the practical system.

    \paragraph
    In this chapter the system identification techniques will be applied to practical flight data.
    The performance of the techniques will also be evaluated for practical flights with a dynamic payload.
    Furthermore, the suitability of the system identification models
    for swing damping control will be investigated in simulation.
    The performance of the swing damping controllers will be evaluated for a range of different system configurations.
    HITL simualtions will also be performed to determine whether the proposed hardware 
    can handle the computational complexity of these controllers.
    Finally, it will be determined whether the proposed control architectures are feasable for practical flights.

    \FloatBarrier\section{Methodology}
        
        \paragraph
        As discussed in Chapter~\ref{chap:system_id}, 
        generating data for the parameter estimation techniques involves two flight stages.
        Firstly, the mulitrotor hovers with the suspended payload to gather data for payload mass estimation.
        Then a velocity step setpoint is commanded
        to stimulate the swinging payload system and gather data for cable length estimation.
        Hence, the same methodology that was followed simulated flights will be used for practical flights.

        \paragraph
        For the data-driven techniques, the generation of practical training and testing data
        also follows the same general methodolgy as simulated flights:
        \begin{enumerate}
            \item Data logging starts when the mulitrotor is armed
            \item Takeoff and hover with the qaudrotor
            \item Command velocity step setpoints
            \item Land the mulitrotor
            \item Data logging stops when the mulitrotor is disarmed
            \item Download data log from the mulitrotor
            \item Split data into separate training and testing periods
            \item Build a model from the training data
            \item Perform model predictions over the testing data to calculate an error metric
        \end{enumerate}

        \paragraph
        Figure~\ref{fig:honeybee_with_payload} shows Honeybee with a suspended payload during a practical flight.
        Numerous flights were performed with different 
        payload masses, 
        cable lengths, 
        wind conditions, 
        and dynamic payloads.
        The system identification methods were then performed on data resulting from this wide range of different use cases.
        
        \paragraph
        The major differences between the simulated and practical flights involve the attachment of the payload and wind disturbances.
        In simulation, the payload cable is attached to the exact \gls{CoM} of the mulitrotor.
        However for practical flights the cable is attached slightly below the \gls{CoM} of Honeybee due to mechanical constraints.
        Practical flights are also influenced by wind disturbances which was not considered in simulation.
        The measurement noise experienced by a practical multirotor may also differ from the noise models used in simulation.
        Therefore this effect is also investigated in the sections below.

        \begin{figure}[!htb]
            \centering
            \includegraphics[width=0.5\linewidth]{honeybee_with_payload.jpg}
            \caption{Practical flight with Honeybee and a suspended payload}
            \label{fig:honeybee_with_payload}
        \end{figure}
        
        % \begin{itemize}
        %     \item Method for generating data
        %     \item Plot example of training data
        %     \item picture of practical flight single and double
        %     \item Discuss difference between \gls{SITL} and prac
        %     \begin{itemize}
        %         \item Noise 
        %         \item wind
        %         \item \gls{CoM}
        %     \end{itemize}
        %     \item plot hover of prac vs \gls{SITL} to show noise and disturbance
        % \end{itemize}

        % \paragraph
        % In Chapter~\ref{chap:system_id} it was noted that the optimal length of training data 
        % often only included 2 velocity steps responses.
        % This means the models were trained on a very small sample of step sizes 
        % and need to extrapolate the dynamics of other step sizes.
        
    \FloatBarrier\section{Parameter estimation with practical data}

        \paragraph
        In Section~\ref{sec:param_estimation}, parameter estimation was performed with simulation data.
        It was shown that the models with the estimated parameter values provide reasonably accurate representations of the simulated dynamics.
        In this section practical flight data is used for paramater estimation.
        The effect of wind on the parameter estimation techniques will also be investigated.
        
        %% ?? Add this if there is time
        % \subsection{Mass estimation} 
        
        %     As discussed in Chapter~\ref{chap:system_id}, for this method to work, the mass of the mulitrotor needs to be known.
        %     If a heavier battery or an extra accessory is added to the vehicle, 
        %     the new vehicle mass will first have to be estimated in a separate flight, before the payload can be attached.
        %     This is one of the disadvantages of the white-box modelling with parameter estimation based techniques.
        %     The method is designed with a specific system in mind 
        %     and needs to be adjusted and redesigned for every deviation from the the pre-assumed configuration.
        %     In contrast, the data-driven technique is a general solution which works for a much wider range of system configurations.
        %     The data-driven technique is not readjusted for an added vehicle mass, 
        %     since the whole model is estimated instead of specific parameters.

        \FloatBarrier\subsection{Simple payload cable length estimation}
            
            \paragraph
            As discussed in Section~\ref{sec:length_estimation}, an \gls{FFT} of the payload oscillations 
            is used to estimate the natural frequency of the suspended payload, 
            and the natural frequency is used to calculate the estimated cable length.
            \gls{PE} is the error metric used to quantify the estimation accuracy.
            The \gls{PE} of the cable length estimation is calculated as,
            \begin{equation}
                PE = \frac{ l_{actual} - l_{estimated} }{ l_{actual} } \times 100 \% ,
            \end{equation}
            where $l_{actual}$ is the actual cable length and $l_{estimated}$ is the estimated cable length.

            \paragraph
            Figure~\ref{fig:cable_length_vs_train_time} shows the \gls{PE} of the cable length estimation 
            with different payload masses and cable lengths.
            Note that for each payload configuration, 
            the estimation converges to a constant error after a sufficient length of training data.
            %% ?? Add length of training data required to all techniques to compare white-box length to black box length
            For these payload configurations the converged \gls{PE} ranges from 18.9~\% to 32.4~\%.
            These errors may be due to the large difference between theoretical and the damped natural frequency.
            It appears that the \gls{PID} controllers damp the payload oscillations significantly, 
            which changes oscillation frequency of the payload.
            Hence, an incorrect length is calculated from the frequency peak identified in the \gls{FFT}.
            
            \input{results/plots/cable_length_vs_train_time.tex}

            \paragraph
            Figure~\ref{fig:cable_length_vs_train_time_wind} shows the \gls{PE} of cable length estimation 
            for flights with different wind conditions.
            These flights were all performed with the same payload parameters.
            It appears that the wind speed does affect the parameter estimation, 
            since the estimation error differs significantly for different wind speeds.
            This may be due to the variable damping effect the controllers have on the payload at different wind speeds.
            From the considered flights, it appears that the largest \gls{PE} occurs at the highest wind speed, 
            and the lowest \gls{PE} at the lowest wind speed.
            However, too few flights with different wind conditions are considered to identify a trend conclusively.

            \input{results/plots/cable_length_vs_train_time_wind.tex}

            \paragraph
            Note that the estimation \gls{PE} converges for each considered flights with a different wind speed,
            even with wind speeds up to \SI{6}{\metre/\second}.
            Therefore a dominant oscillation frequency emerges from each flight, 
            even when the multirotor is heavily affected by wind.
            % ?? Maybe add this if there is time: and show effect of effective length vs actual length in system id chapter.
            % As discussed in Section~\ref{sec:param_estimation}, 
            % the effective cable length corresponding to the dominant frequency is more important
        
        \FloatBarrier\subsection{Dynamic payload cable length estimation}

            \paragraph
            As discussed in Chapter~\ref{chap:system_id}, 
            the dynamical equations in a white-box model are fixed in the a priori modelling phase.
            The model is then completed with values from parameter estimation.
            However, when the dynamics of the observed system differs from the pre-determined model,
            the paramter estimation algorithms still determine a naive, best-fit value for the pre-determined model.
            
            \begin{figure}
                \captionsetup[subfigure]{justification=centering}
                \centering
                \input{results/plots/FFT_vel_step_double_pend.tex} % subfigure
                \input{results/plots/FFT_double_pend.tex} % subfigure
                \caption{Data from a velocity step response with a dynamic payload 
                ($m_1 =$~\SI{0.2}{\kilo\gram}, $l_1 =$~\SI{0.5}{\meter}, $m_2 =$~\SI{0.1}{\kilo\gram}, $l_2 =$~\SI{0.6}{\meter}).}
                \label{fig:FFT_double_pend_prac_subfigs}  
            \end{figure}

            \paragraph
            Figure~\ref{fig:FFT_vel_step_double_pend} shows a snapshot of payload angle data from a practical flight with a dynamic payload.
            Two superimposed frequencies clearly visible in the oscillations due to the double pendulum action of the elongated pendulum.
            Two peaks corresponding to these two frequencies can be identified 
            from the resulting FFT amplitude spectrum in Figure~\ref{fig:FFT_double_pend}.
            The cable length estimation uses the frequency of the dominant peak 
            and calculates the effective length corresponding to that frequency.
            This models a simple pendulum plant that best matches the dynamic payload oscillations. 

            \paragraph
            Figure~\ref{fig:double_pend_cable_length_vs_train_time} shows the estimated cable length 
            as a function of length of trainning data for a practical dynamic payload.
            Note how the estimated length converges as the length of training data increases.
            As the size of the payload swing angles decrease due to damping, 
            the relative oscillations of the elongated payload also decrease.
            Therefore the effect of the superimposed higher frequency oscillations in the angle data is less prominant 
            and the system dynamics approximate a simple pendulum more closely.

            \input{results/plots/double_pend_cable_length_vs_train_time.tex}
            
    \FloatBarrier\section{Data-driven system identification with practical data}

        \paragraph
        In Chapter~\ref{chap:system_id} it was shown that the data-driven methods 
        build accurate state prediction models for the considered system.
        It was also shown in Chapter~\ref{chap:modelling} that the simulation environment is a realistic representation of the practical system.
        However, there are still differences between simulations and practical flight.
        Therefore the data-driven algorithms are applied to practical flight data in this chapter 
        to investigate their performance in a practical implementation.

        \FloatBarrier\subsection{Length of training data}

            \paragraph
            As discussed in Section~\ref{sec:sys_id_length_of_data}, 
            the length of training data used in the model has a large effect on prediction accuracy.
            The length of training data required for accurate models is largely influenced by the amount of wind disturbance during flight.
            Figure~\ref{fig:wind_Ttrain} shows prediction error as a function of training data length for different wind conditions.
            Wind conditions are referenced here by the wind speed recorded by the website, www.yr.no, 
            for the hour of day of the flight.
            Its clear that the prediction error decreases with increasing wind speeds.
            It appears that for wind speeds lower than \SI{2}{\metre/\second}, 
            the minimum prediction error is not significantly improved with decreasing wind speeds.
            This may be because the flight dynamics is not significantly affected at such low wind speeds.
            
            \paragraph
            Wind adds an unmeasured input, also referred to as process noise, to the plant and this is not accounted for in the model.
            As discussed in Section~\ref{sec:noise}, the constant offset is subtracted from the acceleration setpoint data, 
            which results in a signal with a zero mean.
            This accounts for the constant component in the acceleration setpoint signal required to counteract the mean force of the wind.
            However, the wind speed deviates randomly from the mean speed which results in random process noise in the plant.

            % \paragraph
            % It appears that for higher wind speeds, 
            % the prediction error does not reach a peak value within the considered range of training data lengths.
            
            % This is expected, since the algorithms require longer lengths of training data to  
            
            \input{results/plots/wind_Ttrain.tex}
            
            \paragraph
            \gls{HAVOK} and \gls{DMD} perform similarly
            Figure~\ref{fig:havok_vs_dmd_Ttrain_2mps} shows the prediction error of \gls{DMD} and \gls{HAVOK} models
            
            \input{results/plots/havok_vs_dmd_Ttrain_2mps.tex}

            Also plot \gls{DMD} vs \gls{HAVOK} for high winds ??
            

            plot \gls{NMAE} vs Ttrain
            \begin{itemize}
                \item Plot strong wind vs less wind vs no wind
                \item \gls{HAVOK} vs \gls{DMD}
                \item Plot single pend vs double pend
            \end{itemize}
            
        \FloatBarrier\subsection{Hyperparameters}
            
            \paragraph
            As discussed in Section~\ref{sec:hyperparameters}, 
            the prediction error generally improves with an increasing number of delay-coordinates 
            because the number of parameters in the model increases.
            However, the prediction error reaches a pareto optimum, 
            after which the error does not significantly decrease with an increasing number of terms anymore.
            Figure~\ref{fig:havok_vs_dmd_q_2mps} shows the prediction error as a function of the number of delay-coordinates
            for practical flight data.
            Even though the pareto elbow is not as smooth and clear as models build from simulation data, 
            the elbow can still be identified.            
            % Note that the pareto elbow is not as smooth and clear as shown in Section~\ref{sec:hyperparameters}.
            % This may due to random 
            % The pareto optimal models for practical data have significantly more delay-coordinates than

            \input{results/plots/havok_vs_dmd_q_2mps.tex}

            % \input{results/plots/prac_singular_values.tex}
            % Difference between SITl and practical (same input steps)
            % This is due to wind disturbance
            % Plot wind vs less wind vs no wind
            
        \FloatBarrier\subsection{System parameters}

            \paragraph
            It was shown with multiple simulations in Section~\ref{sec:system_params} 
            that the system identification methods work for a range of different payload parameters.
            Figure~\ref{fig:prac_system_params} shows the prediction error for different payloads with practical data.
            This shows that the proposed methods also work in practice with different payloads.
            The `double-descent' trend is clearly seen in all of the plots, 
            where the prediction error increases slightly after a specific length of training data,            
            
            \input{results/plots/prac_system_params.tex}

        \FloatBarrier\subsection{Predictions}

            \paragraph
            Notice how the prediction deviates more from the measured value as time progresses.
            This is because of the build up, discrete, initial condition 

            \input{results/plots/prac_pediction_single_pend_theta_black.tex}

            \paragraph
            
            \input{results/plots/prac_pediction_single_pend_vel_black.tex}
        
        \FloatBarrier\subsection{Extended dimensions}

            \paragraph
            This method can easily be extended to damp the swing angle in both the $x$ and $y$ directions.
            Show new control vector and new state vector.
            Talk about steps given.
            Figure~\ref{fig:xy_predictions} \gls{DMD} predictions

            \begin{figure}
                \captionsetup[subfigure]{justification=centering}
                \centering
                \input{results/plots/prac_pediction_xy_theta_x.tex} % subfigure
                \input{results/plots/prac_pediction_xy_theta_y.tex} % subfigure
                \input{results/plots/prac_pediction_xy_vel_x.tex} % subfigure
                \input{results/plots/prac_pediction_xy_vel_y.tex} % subfigure
                \caption{Data-driven predictions of practical data for a model with both North and East axis dynamics}
                \label{fig:xy_predictions}  
            \end{figure}

        %     Maybe add plot error vs q if there is time??

        \FloatBarrier\subsection{Dynamic payload} 

            \paragraph
            As mentioned in Chapter~\ref{chap:system_id}, 
            one of the disadvantages of the white-box system identification approach
            is that it relies heavily on a priori modeling assumptions.
            When a payload is attached that deviates from the white-box modelling assumptions, 
            the performance of the system identification method decreases.
            However, the performance of the data-driven methods can handle this deviation
            because it does not rely on these assumptions.

            \paragraph
            One of the main assumptions of the white-box model considered in Section~\ref{sec:param_estimation},
            is that the suspended payload is a point mass.
            This reduced the considered suspended payload system to a simple pendulum.
            Figure~\ref{fig:practical_double_pendulum} shows a practical dynamic payload 
            which deviates significantly from this assumption.
            It shows a photo of an elongated payload 
            suspended from Honeybee during a practical flight.
            The mass distribution causes a relative rotation of the payload with respect to the suspended cable,
            which significantly affects the flight dynamics.

            \begin{figure}[!htb]
                \centering
                \includegraphics[width=0.6\linewidth]{practical_double_pendulum_2.jpg}
                \caption{Practical flight with an suspended elongated payload attached to Honeybee}
                \label{fig:practical_double_pendulum}
            \end{figure}

            \paragraph
            Theta prediction.

            \input{results/plots/prac_pediction_double_pend_theta_black.tex}
            
            \paragraph
            Vel prediction.
            Note that the prediction is propagated from an initial condition and the given input data only.
            The model does not use state measurements to readjust after the initial condition is taken.
            Because the model prediction matches the practical testing data so closely,
            it is expected that this model can effectively be used for a practical \gls{MPC} implementation. 

            % As discussed in Chapter~\ref{chap:control_systems}, 
            % this prediction model can be used in an \gls{MPC} to optimise the control input to actively damp the payload swing angles.
            % It was also noted in Chapter~\ref{chap:control_systems} that the accuracy of the model 
            % has a direct impact on the performance of the controller.
            % Because the model prediction matches the practical testing data so closely,
            % it is expected that this model will 

            \input{results/plots/prac_pediction_double_pend_vel_black.tex}
            
            \paragraph
            Double pendulum: 
            \begin{itemize}
                \item Plot theta
                \item Plot velocity
                \item Plot theta prediction of white-box model
            \end{itemize}
            
        % \FloatBarrier\subsection{Extended dimensions}
        %     \begin{itemize}
        %         \item plot error vs T-train for XY
        %         \item plot predictions
        %         \item plot error vs T-train for XYZ
        %     \end{itemize}
        %     Maybe add this is there is time??
            
    \FloatBarrier\section{Swing damping control systems}

        \paragraph
        After the system identification phase, active swing damping control can be applied
        to the mulitrotor and payload system.
        The control architectures are summarised in Table~\ref{tbl:controller_summary} 
        by pairing the system identification techniques along with the appropriate controllers.
        It was firstly shown in Chapter~\ref{chap:system_id} that the system identifcation techniques worked in simulation.
        Emphasise that control is now applied in full \gls{SITL} simulation.

        \paragraph
        MATLAB is used to generate a \gls{MPC} \gls{ROS} node 
        This \gls{ROS} node receives state feedback from the Gazebo simulator,
        computes the optimal control action,
        and send the setpoint to PX4 through the package 'mavros'.

        \begin{table}[!h]
            \renewcommand{\arraystretch}{1.1}
            \centering
            \caption{Summary of the system identification techniques paired with the active damping controllers.}
            \begin{tabularx}{0.75\linewidth}{@{}lll@{}}
                \toprule
                \multicolumn{2}{c}{\textbf{System identification}}   & \textbf{Controller} \\
                \cmidrule(lr){1-2}
                Category    & Algorithm                     & \\
                \midrule
                White-box   & RLS mass estimator, and       & LQR \\
                            & FFT cable length estimator    & \\
                Black-box   & DMDc, or                      & MPC \\
                            & HAVOK                         & \\
                \bottomrule
            \end{tabularx}
            \label{tbl:controller_summary}
        \end{table}
        

        \FloatBarrier\subsection{Single pendulum}

            \begin{itemize}
                \item subplot prediction of data driven model. subplot prediction of white-box model
                \item plot \gls{MPC} vs \gls{LQR} v \gls{PID} (no wind) step = 1 m/s
                \item plot \gls{MPC} vs \gls{LQR} v \gls{PID} (no wind) step = 2 m/s
                \item plot \gls{DMDc} vs \gls{HAVOK} (\gls{DMD} - Havok)
                \item plot with wind disturbacne control
            \end{itemize}

        \FloatBarrier\subsection{Double pendulum}

            \begin{itemize}
                \item subplot prediction of data driven model. subplot prediction of white-box model
                \item plot \gls{MPC} vs \gls{LQR} v \gls{PID} (no wind)
                \item plot \gls{DMDc} vs \gls{HAVOK} (\gls{DMD} - Havok)
            \end{itemize}

    \section{HITL}

    \section{Conclusion}


