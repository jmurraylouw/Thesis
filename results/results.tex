\graphicspath{{results/fig/}}
{
\tikzset{external/figure name/.add={results/}{}}

\chapter{Practical implementation and results}
\label{chap:results}

    \paragraph
    In previous chapters, it was shown with simulation data that both the white-box and black-box system identification models could
    accurately represent the dynamics of a multirotor with a suspended payload.
    However, practical flights may differ significantly from simulations, which would affect the performance of these techniques.
    Wind is a common unmeasured disturbance that influences the flight dynamics of a multirotor, 
    but this disturbance was not considered in simulations.
    The practical dynamics and sensor noise may also differ from the simulation model, which further motivates the need for practical data.
    
    \paragraph
    In this chapter, the system identification techniques will be applied to practical flight data.
    The effect of different wind conditions and payloads on the performance of these techniques will be investigated.
    These techniques will also be evaluated with a practical dynamic payload.
    % Furthermore, the suitability of the system identification models
    % for swing damping control will be investigated in simulations.
    % The performance of the swing damping controllers will be evaluated for a range of different system configurations.
    Furthermore, \gls{HITL} simulations will be performed to determine whether the proposed hardware can handle the computational complexity of these algorithms.
    Finally, the practical feasibility of the proposed system identification and control architectures will be discussed.
    % ?? Add \gls{HITL} results to this chapter

    \FloatBarrier\section{Methodology}
        
        \paragraph
        As discussed in Chapter~\ref{chap:system_id}, 
        generating data for the parameter estimation techniques involves two distinct flight stages.
        Firstly, the multirotor hovers with the suspended payload to gather data for payload mass estimation.
        A velocity step setpoint is then commanded to stimulate the swinging payload system for cable length estimation.
        Hence, the same methodology used for simulations will be used for practical flights.

        \paragraph
        For the data-driven techniques, the generation of practical training and testing data
        also follows the same general methodology as simulated flights:
        \begin{enumerate}
            \item Data logging starts when the multirotor is armed
            \item Takeoff and hover with the multirotor
            \item Command velocity step setpoints
            \item Land the multirotor
            \item Data logging stops when the multirotor is disarmed
            \item Download the data log from the multirotor
            \item Split the data into separate training and testing periods
            \item Build a model from the training data
            \item Perform model predictions over the testing data to calculate an error metric
        \end{enumerate}

        \paragraph
        Figure~\ref{fig:honeybee_with_payload} shows the Honeybee multirotor with a suspended payload during a practical flight.
        Numerous flights were performed with different 
        payload masses, 
        cable lengths, 
        wind conditions, 
        and dynamic payloads.
        The system identification methods were then performed on data resulting from this wide range of different use cases.
        
        \paragraph
        The major differences between the simulated and practical flights involve the attachment of the payload and wind disturbances.
        In simulations, the payload cable is attached to the exact \gls{CoM} of the multirotor.
        However, for practical flights the cable is attached slightly below the \gls{CoM} of Honeybee due to mechanical constraints.
        Practical flights are also influenced by wind disturbances which were not considered in simulations.
        The measurement noise experienced by a practical multirotor may also differ from the noise models used in simulations.
        Therefore this effect will also be investigated in the sections below.

        \begin{figure}[!htb]
            \centering
            \includegraphics[width=0.5\linewidth]{honeybee_with_payload.jpg}
            \caption{Practical flight with Honeybee and a suspended payload}
            \label{fig:honeybee_with_payload}
        \end{figure}
        
        % \begin{itemize}
        %     \item Method for generating data
        %     \item Plot example of training data
        %     \item picture of practical flight single and double
        %     \item Discuss difference between \gls{SITL} and prac
        %     \begin{itemize}
        %         \item Noise 
        %         \item wind
        %         \item \gls{CoM}
        %     \end{itemize}
        %     \item plot hover of prac vs \gls{SITL} to show noise and disturbance
        % \end{itemize}

        % \paragraph
        % In Chapter~\ref{chap:system_id} it was noted that the optimal length of training data 
        % often only included 2 velocity steps responses.
        % This means the models were trained on a very small sample of step sizes 
        % and need to extrapolate the dynamics of other step sizes.
        
    \FloatBarrier\section{Parameter estimation with practical data}

        \paragraph
        In Section~\ref{sec:param_estimation}, parameter estimation was performed with simulation data.
        It was shown that the models which use the estimated parameter values provide reasonably accurate representations of the simulated dynamics.
        In this section, practical flight data will be used for parameter estimation.
        The effect of wind on the parameter estimation techniques will also be investigated.
        
        %% ?? Add this if there is time
        % \subsection{Mass estimation} 
        
        %     As discussed in Chapter~\ref{chap:system_id}, for this method to work, the mass of the multirotor needs to be known.
        %     If a heavier battery or an extra accessory is added to the vehicle, 
        %     the new vehicle mass will first have to be estimated in a separate flight before the payload can be attached.
        %     This is one of the disadvantages of white-box modelling with parameter estimation based techniques.
        %     The method is designed with a specific system in mind 
        %     and needs to be adjusted and redesigned for every deviation from the pre-assumed configuration.
        %     In contrast, the data-driven technique is a general solution that works for a much wider range of system configurations.
        %     The data-driven technique is not readjusted for an added vehicle mass, 
        %     since the whole model is estimated instead of specific parameters.

        \FloatBarrier\subsection{Simple payload cable length estimation}
            
            \paragraph
            As discussed in Section~\ref{sec:length_estimation}, an \gls{FFT} of the payload angle data is used to estimate the natural frequency of the suspended payload, 
            which is used to estimate the cable length.
            \gls{PE} will be used as the error metric to quantify the estimation accuracy.
            The \gls{PE} of the cable length estimation is calculated as,
            \begin{equation}
                PE = \frac{ l_{estimated} - l_{actual} }{ l_{actual} } \times 100 \% ,
            \end{equation}
            where $l_{actual}$ is the actual cable length and $l_{estimated}$ is the estimated cable length.
            The \gls{PE} can be interpretted as the percentage of the actual length by which the actual length differs from the estimated length.
            
            \input{results/plots/cable_length_vs_train_time.tex}

            \paragraph 
            Figure~\ref{fig:cable_length_vs_train_time} shows the \gls{PE} of the cable length estimation 
            with different payload masses and cable lengths.
            Note that for each payload configuration, 
            the estimation converges to a constant error after a sufficient length of training data.
            %% ?? Add the length of training data required to all techniques to compare white-box length to black-box length
            For these payload configurations, the converged \gls{PE} ranges from 18.9~\% to 32.4~\%.
            These errors may be due to the large difference between the theoretical and the damped natural frequency.
            It appears that the \gls{PID} controllers damp the payload oscillations significantly, 
            which affects the oscillation frequency of the payload.
            Hence, an inaccurate length is estimated from the frequency peak identified in the \gls{FFT}.
            % The estimation accuracy could be improved by including the effect of damping in the calculation of the cable length from the measured natural frequency.
            % However, it was shown by \cite{Slabber2020} that this is
            
            \input{results/plots/prediction_single_pend_white_prac.tex}

            \paragraph
            Figure~\ref{fig:prediction_single_pend_white_prac} compares the actual payload angle to the predicted angle of the white-box model for a velocity step in a practical flight. 
            The cable length estimated from this flight is \SI{2.64}{\metre} resulting in a \gls{PE} of 32.0~\%.
            The prediction matches the general shape of the practical data well.
            The transient response of the practical data is noticeably different from the model prediction.
            This can be seen in the first two oscillation peaks.
            This is probably due to the dynamics of the inner loop controllers which are not account for in the white-box model but affects the transient response of the practical data.
            Furthermore, note that the payload swing angle peaks are attenuated by non-linear damping,
            but the white-box model prediction shows linear damping.
            This is a minor modelling error expected from a simple linear approximation of a non-linear system. 

            % \input{results/plots/prediction_single_pend_white_prac_bad.tex}
            % \paragraph
            % Figure~\ref{fig:prediction_single_pend_white_prac_bad} shows the white-box prediction of practical data, when the step input is seen after the initial condition

            % \paragraph
            % The naive assumption regarding the speed of the inner loop \gls{PID} controller probably adds to the modelling error significantly.
            % As discussed in Chapter~\ref{chap:modelling}, the white-box model assumes that the time scale separation between the velocity and attitude controller is large enough for the acceleration setpoint to approximate the actual separation.
            % However, it appears that the attitude controller of the practical multirotor is slow enough to significantly affect the transient response of the swing angle.
            % Notice how the first two oscillation peaks differ noticeably from the expected linear damping shape.
            % Since the payload is attached below the \gls{CoM} of the multirotor, the oscillating pitch angle of the multirotor also affects the swing angle of the payload.

            % ?? However, as discussed in Chapter~\ref{chap:control}, the \gls{LQR} controller which utilises the white-box model is quite robust against model uncertainty and may still result in acceptable control with such a model.
            % Recall from Chapter~\ref{chap:system_id} that the damping coefficient is not estimated, but a manually tuned value is used.

            \input{results/plots/cable_length_vs_train_time_wind.tex}

            \paragraph
            Figure~\ref{fig:cable_length_vs_train_time_wind} shows the \gls{PE} of cable length estimation for flights with different wind conditions.
            These flights were all performed with the same payload.
            Wind conditions are referenced here by the wind speed recorded by the website, www.yr.no, for the hour of the day of the flight.
            It appears that the wind speed affects the parameter estimation result since the estimation error differs significantly for different wind speeds.
            This may be due to the variable damping effect of the controllers at different wind speeds.
            From the considered flights, it appears that the largest \gls{PE} occurs at the highest wind speed, 
            and the lowest \gls{PE} at the lowest wind speed.
            However, only a few different wind speeds were tested and a trend cannot be identified conclusively from this small sample.

            \paragraph
            Note in Figure~\ref{fig:cable_length_vs_train_time_wind} that the estimation \gls{PE} converges for each considered flight with a different wind speed,
            even with wind speeds up to \SI{6}{\metre/\second}.
            Therefore a dominant oscillation frequency emerges from each flight, 
            even when the multirotor is heavily affected by wind.
            % ?? Maybe add this if there is time: and show the effect of effective length vs actual length in the system id chapter.
            % As discussed in Section~\ref{sec:param_estimation}, 
            % the effective cable length corresponding to the dominant frequency is more important
        
        \FloatBarrier\subsection{Dynamic payload cable length estimation} \label{sec:dynamic_payload_prac}

            \paragraph
            As discussed in Chapter~\ref{chap:system_id}, 
            the dynamical equations of a white-box model are fixed in the a priori modelling phase.
            The model is then populated with values from parameter estimation techniques.
            However, when the dynamics of the observed system differ significantly from the pre-determined model,
            the parameter estimation algorithms still determine naive, best-fit values for the pre-determined model.

            \begin{figure}[!htb]
                \centering
                \includegraphics[width=0.6\linewidth]{practical_double_pendulum_2.jpg}
                \caption{Practical flight with an suspended elongated payload attached to Honeybee}
                \label{fig:practical_double_pendulum}
            \end{figure}     

            \paragraph
            One of the a priori modelling assumptions mentioned in Section~\ref{sec:param_estimation},
            is that the suspended payload is a point-mass.
            This reduced the considered suspended payload system to a simple pendulum in the white-box model.
            Figure~\ref{fig:practical_double_pendulum} shows a photo of an elongated payload suspended from Honeybee during a practical flight
            This is a practical example of a dynamic payload that deviates significantly from the point-mass assumption.
            The mass distribution causes a relative rotation of the payload with respect to the suspended cable,
            which significantly affects the flight dynamics.
            
            \begin{figure}
                \captionsetup[subfigure]{justification=centering}
                \centering  
                \input{results/plots/FFT_vel_step_double_pend.tex} % subfigure
                \input{results/plots/FFT_double_pend_prac.tex} % subfigure
                \caption{White-box model prediction for a North velocity step input for a dynamic payload
                ($m_1 =$~\SI{0.2}{\kilo\gram}, $l_1 =$~\SI{0.5}{\meter}, $m_2 =$~\SI{0.1}{\kilo\gram}, $l_2 =$~\SI{0.6}{\meter}) }
                \label{fig:FFT_double_pend_prac_subfigs}  
            \end{figure}

            \paragraph
            Figure~\ref{fig:FFT_vel_step_double_pend} shows a snapshot of payload angle data from a practical flight with a dynamic payload.
            Two superimposed frequencies are clearly visible in the payload oscillations due to the double pendulum action of the elongated pendulum.
            The two peaks corresponding to these two frequencies can easily be identified from the FFT amplitude spectrum in Figure~\ref{fig:FFT_double_pend_prac}.
            The cable length estimation method uses the frequency of the dominant peak and calculates the effective length corresponding to that frequency.
            This results in a simple pendulum model that best matches the dynamic payload oscillations. 

            \input{results/plots/double_pend_cable_length_vs_train_time.tex}
            
            \paragraph
            Figure~\ref{fig:double_pend_cable_length_vs_train_time} shows the estimated cable length 
            as a function of the length of training data for a practical dynamic payload.
            Note that the estimated length converges after a sufficient length of training data, showing that a dominant oscillation frequency can be identified.
            For this flight, the estimated cable length is \SI{1.03}{\metre}.
            
            \begin{figure}
                \captionsetup[subfigure]{justification=centering}
                \centering  
                \input{results/plots/prediction_double_pend_white_prac.tex} % subfigure
                \input{results/plots/prediction_double_pend_white_prac_bad.tex} % subfigure
                \caption{Data from a velocity step response with a dynamic payload 
                ($m_1 =$~\SI{0.2}{\kilo\gram}, $l_1 =$~\SI{0.5}{\meter}, $m_2 =$~\SI{0.1}{\kilo\gram}, $l_2 =$~\SI{0.6}{\meter}).}
                \label{fig:predictions_double_pend_prac_subfigs}  
            \end{figure}

            \paragraph
            Figure~\ref{fig:predictions_double_pend_prac_subfigs} shows two model predictions resulting from slightly different starting points in flight data.
            The two prediction runs in Figure~\ref{fig:predictions_double_pend_prac_subfigs} differ significantly from each other even though the starting points of the predictions are offset by only \SI{0.06}{\second}.
            Since the oscillations of the dynamic payload are irregular compared to the sinusoidal dynamics of the white-box model, the prediction accuracy is very sensitive to the initial condition.
            
            \input{results/plots/prediction_double_pend_white_prac_diff_IC.tex}
            
            Figure~\ref{fig:prediction_double_pend_white_prac_diff_IC} shows the white-box model predictions for the dynamic payload data with slightly different starting positions in the data.
            Note how much the predictions differ even though the starting points are so close together. 
            This shows how sensitive the white-box model is to the initial condition of the prediction.
            This is because the white-box model consists of ordinary differential equations depend on the initial angular rate of the payload.
            Even though the oscillations of the dynamic payload have an approximate sinusoidal shape, the time derivative of the data differs significantly from the sinusoidal white-box dynamics.
            This is clear from numerous infliction points in the payload angle data shown in Figure~\ref{fig:predictions_double_pend_prac_subfigs}.
            
            % ?? Could add this if there is time
            % Recall from Chapter~\ref{chap: modelling} that the white-box model consists of ordinary differential equations.
            % Therefore the payload angle prediction depends on both the payload angle and angular rate at the prediction starting point.
            % For example, there is an inflexion point in the measured payload angle near $Time =$~\SI{2}{\second} in Figure~\ref{fig:predictions_double_pend_prac_subfigs}.
            % If the white-box model prediction starts at this point, the initial angular rate is zero and the initial payload angle is positive.
            % Therefore the white-box model wrongly predicts that this corresponds to the peak of an oscillation, where the practical data shows that the payload angle is in ascend at this point.

            \paragraph
            However, as the size of the swing angles attenuate the relative oscillations of the elongated payload also decrease.
            Therefore the effect of the superimposed higher frequency oscillations become less prominent and the system dynamics approximate a simple pendulum more closely.
            For example, in Figure~\ref{fig:predictions_double_pend_prac_subfigs} it can be seen that the oscillations after $Time =$~\SI{12}{\second} are much less irregular than before. 
            Therefore the simple pendulum model provides a decent representation of a practical dynamic payload for small swing angles.
            Overall, the white-box model represents the general shape of the practical data, but does not capture the transient response of the system and is very sensitive to initial conditions. 
            
    \FloatBarrier\section{Data-driven system identification with practical data} \label{sec:data_driven_sys_id_prac}

        \paragraph
        In Chapter~\ref{chap:system_id} it was shown that the considered data-driven methods build accurate models of the system dynamics from simulation data.
        It was also shown in Chapter~\ref{chap:modelling} that the simulation environment is a realistic representation of the practical system.
        However, there are still differences between simulations and practical flights.
        Therefore the data-driven algorithms will be applied to practical flight data in this chapter to evaluate their suitability for practical implementations.

        \FloatBarrier\subsection{Wind disturbance} \label{sec:length_train_data_prac}

            \paragraph
            The wind conditions during practical flights have a large influence on the quality of the flight data gathered.
            Wind adds an unmeasured disturbance (also referred to as process noise) 
            to the considered system which is detrimental to system identification.
            This disturbance consists of a randomly fluctuating force applied to the vehicle, cable and payload.
            It is very difficult to model these forces accurately and to determine accurate drag coefficients of the practical system for realistic simulations.

            \paragraph
            The mean force applied to the multirotor by the wind affects the mean offset in acceleration setpoint data 
            because the velocity controller integrators compensate for the disturbance.
            The mean offset is subtracted from the acceleration setpoint data, 
            which results in a signal with a zero mean which is used for system identification.
            This accounts for the mean force applied by the wind.
            % ??  As shown in Figure~\ref{fig:}, this greatly reduces the prediction error.
            However, the wind speed also fluctuates from the mean randomly.
            This results in random process noise in the plant which cannot easily be removed from the measured data.

            % ?? Shows a plot of data with high wind and low wind

            \input{results/plots/wind_Ttrain.tex}

            \paragraph
            Figure~\ref{fig:wind_Ttrain} shows prediction error as a function of training data length for different wind conditions.
            This plot shows that the minimum prediction error decreases with decreasing wind speeds.
            This is expected since lower wind speeds correspond to less process noise which is beneficial for system identification.
            Note that the prediction error corresponding to \SI{6}{\metre/\second} winds does not vary much with the length of training data.
            % This may be because the unmeasured wind disturbance dominates the flight dynamics such the data-driven algorithms cannot identify a representative model with any length of training data. 
            The prediction error at this wind speed is quite large and a model generated from such data will probably not be useful for control.
            %  ?? Figure of prediction with wind clearly shows that the prediction model does not represent the actual flight dynamics.

            \input{results/plots/havok_vs_dmd_Ttrain_2mps.tex}

            \paragraph
            Figure~\ref{fig:havok_vs_dmd_Ttrain_2mps} compares the prediction errors of \gls{DMDc} and \gls{HAVOKc} models.
            It is evident that the two techniques produce similar prediction errors for different wind conditions.
            The difference in prediction error is very small and will probably not affect the performance of the controllers using these models.
            This affirms the observation in Chaper~\ref{chap:system_id} that the minor difference in the algorithm implementations has a negligible effect on prediction accuracy.
            The \gls{DMDc} implementation is therefore prefered over \gls{HAVOKc} for practical data due to lower computational complexity.

            
        \FloatBarrier\subsection{Hyperparameters} \label{sec:hyperparameters}
            
            \paragraph
            As discussed in Section~\ref{sec:hyperparameters}, 
            the prediction error generally improves for a higher number of delay-coordinates because the number of parameters in the model increases.
            However, the prediction error reaches a Pareto optimum, 
            after which the error does not significantly decrease with an increasing number of terms.
            Figure~\ref{fig:havok_vs_dmd_q_2mps} shows the prediction error as a function of the number of delay-coordinates
            for practical flight data.
            Even though the Pareto elbow is not as smooth and clear as shown in Chapter~\ref{chap:system_id}, 
            the elbow can still be identified.            
            % Note that the Pareto elbow is not as smooth and clear as shown in Section~\ref{sec:hyperparameters}.
            % This may be due to random 
            % The Pareto optimal models for practical data have significantly more delay-coordinates than

            \input{results/plots/havok_vs_dmd_q_2mps.tex}

            % \input{results/plots/prac_singular_values.tex}
            % Difference between SITl and practical (same input steps)
            % This is due to wind disturbance
            % Plot wind vs less wind vs no wind
            
        \FloatBarrier\subsection{System parameters}

            \paragraph
            It was shown with multiple simulations in Section~\ref{sec:system_params} 
            that the system identification methods work for a range of different payload parameters.
            Figure~\ref{fig:prac_system_params} shows the prediction error for different payloads with practical data. 
            This shows that the proposed methods also work in practice with different payload configurations.
            The `double-descent' trend (discussed in Section~\ref{sec:sys_id_length_of_data}) is also seen in the practical data results where the prediction error increases slightly after a specific length of training data.            
            
            \input{results/plots/prac_system_params.tex}

            \paragraph
            Recall that the models producing these predictions do not use a priori information about the plant. 
            Only input and output measurements are used in the model generation. 
            In contrast to the white-box technique, the effect of system parameters such as 
            multirotor mass, 
            payload mass, 
            cable length, 
            and damping coefficients 
            are inherently included in the estimated model.
            Therefore these parameters can all be varied 
            and the system identification algorithm should still be able to determine a prediction model of the system.

        \FloatBarrier\subsection{State predictions}

            \paragraph
            Figure~\ref{fig:prac_pediction_single_pend_theta_black} 
            shows the measured and predicted payload angle data of a suspended payload for a velocity step in a practical flight.
            Note that the model is generated from training data and is tested with a separate set of previously unseen, testing data.
            Figure~\ref{fig:prac_pediction_single_pend_theta_black} plots the state prediction against testing data and it is clear that the prediction data fits the measured data very well.
            
            \paragraph
            Recall from Section~\ref{sec:dmdc} that \gls{DMDc} produces a discrete, state-space model in the form:
            \begin{equation}
                \bm{x}_{k+1} = \bm{A}_{dmd} \bm{x}_k + \bm{A}_d \bm{d}_k + \bm{B}_{dmd} \bm{u}_k .
            \end{equation}
            The state prediction starts at the initial condition, $\bm{x}_0$ and $\bm{d}_0$,
            and predicts the state vector for each succesive time-step, $\bm{x}_{k+1}$, 
            from the state vector, $\bm{x}_{k}$,
            delay vector, $\bm{d}_{k}$
            and input vector, $\bm{u}_{k}$
            at the previous time-step.
            Each of these time-step predictions results in a small error that accumulates with each successive time-step.
            Therefore the prediction error increases as the prediction horizon increases, 
            as shown in Figure~\ref{fig:prac_pediction_single_pend_theta_black}.

            \input{results/plots/prac_pediction_single_pend_theta_black.tex}

            \paragraph
            Figure~\ref{fig:prac_pediction_single_pend_vel_black} 
            shows the measured and predicted North velocity of the same flight.
            The oscillations in the velocity response due to the swinging payload are clearly visible in this plot.
            The model predicts the frequency and size of these oscillations reasonably well.
            Note that predicting the payload angle is significantly easier than predicting the velocity response.
            The payload angle prediction inherently oscillates around a zero mean.
            However, the velocity response has a non-zero mean and depends on numerical integration of the acceleration setpoint data.
            A slight error in the correction of the setpoint offset 
            (discussed in Section~\ref{sec:noise} and Section~\ref{sec:length_train_data_prac})
            may result in a large error in the velocity prediction due to a build-up of integration error.
            However, despite this challenge, the model accurately predicts the velocity step size of the practical data.

            \input{results/plots/prac_pediction_single_pend_vel_black.tex}

            % ?? if there is time. Plot prediction of vel with wind
        
        \FloatBarrier\subsection{Extended dimensions}

            \paragraph
            Because the data-driven methods are only dependant on the input and output data used,
            the prediction model can easily be extended to include more dimensions by adding more state measurement variables.
            In this section, a prediction model is generated and discussed which includes both the North and East axes dynamics.
            Such a model could be used in a single \gls{MPC} velocity controller to damp the payload oscillations in both axes simultaneously.

            \paragraph
            For this model, the state vector is,
            \begin{equation}
                \bm{x} = \begin{bmatrix}
                    V_N & V_E & \theta_N & \theta_E 
                \end{bmatrix}^T ,
            \end{equation}
            and the corresponding input vector is,
            \begin{equation}
                \bm{u} = \begin{bmatrix}
                    A_{N_{sp}} & A_{E_{sp}}
                \end{bmatrix} .
            \end{equation}
            
            \begin{figure}
                \captionsetup[subfigure]{justification=centering}
                \centering
                \input{results/plots/training_data_vel_prac.tex} % subfigure
                \input{results/plots/training_data_theta_prac.tex} % subfigure
                \caption{Snapshot of training data with random velocity step inputs for the North and East axes
                    ($m_p =$~\SI{0.2}{\kilo\gram}, $l =$~\SI{0.5}{\meter})}
                \label{fig:XY_train_data_subfigs}  
            \end{figure}

            \paragraph
            To generate training data, random steps are commanded in the North and East axes simultaneously to excite the dynamics in both axes. 
            Figure~\ref{fig:XY_train_data_subfigs} shows an example of the practical training data used for this extended dimension model.
            Clear oscillations in the payload angle and velocity response of both axes are visible. 
            Figure~\ref{fig:xy_predictions} shows the state variable predictions of a \gls{DMDc} model 
            build from the data in Figure~\ref{fig:XY_train_data_subfigs}.
            It is clear that this model provides an accurate prediction of each state variable considered.
            This shows that the data-driven methods can be effectively extended to include both the North and East axes dynamics. 
            This is a great advantage of the proposed data-driven approach.
            The model is easily adapted for different use cases without redesigning estimation techniques or remodelling the plant manually.

            \begin{figure}
                \captionsetup[subfigure]{justification=centering}
                \centering
                \input{results/plots/prac_pediction_xy_theta_x.tex} % subfigure
                \input{results/plots/prac_pediction_xy_theta_y.tex} % subfigure
                \input{results/plots/prac_pediction_xy_vel_x.tex} % subfigure
                \input{results/plots/prac_pediction_xy_vel_y.tex} % subfigure
                \caption{Data-driven predictions of practical data for a model with both North and East axis dynamics}
                \label{fig:xy_predictions}  
            \end{figure}

        %     Maybe add plot error vs q if there is time??

        \FloatBarrier\subsection{Dynamic payload} 

            \paragraph
            As mentioned in Section~\ref{sec:dynamic_payload_prac}, 
            one of the disadvantages of the white-box system identification approach
            is that it relies heavily on a priori modelling assumptions.
            When a payload is attached to the multirotor that deviates from the white-box modelling assumptions, 
            the performance of the system identification method decreases.
            However, the data-driven methods can handle this deviation
            because it does not rely on these assumptions.
                        
            \input{results/plots/prac_pediction_double_pend_theta_black.tex}

            \paragraph
            Figure~\ref{fig:prac_pediction_double_pend_theta_black} shows the measured and predicted payload angle
            of the practical dynamic payload.
            The irregular oscillations due to the double pendulum action of an elongated payload are visible in the angle data.
            The data-driven model clearly represents the actual payload dynamics well.
            It appears that the prediction differs slightly from the measurement data at the peaks, however, this does not appear to be a significant error.
            Overall, it is clear that the \gls{DMDc} model captures the multi-frequency oscillations of the dynamic payload well.

            \input{results/plots/prac_pediction_double_pend_vel_black.tex}
            
            \paragraph
            Figure~\ref{fig:prac_pediction_double_pend_vel_black} shows the measured and predicted velocity of the same flight.
            The superimposed frequencies are not as visible in the velocity oscillations as they were in the payload angle data.
            However, the oscillations in the velocity response still appear irregular compared to the simple payload data shown in Figure~\ref{fig:prac_pediction_single_pend_vel_black}.
            In Figure~\ref{fig:prac_pediction_double_pend_vel_black}, 
            the size of the velocity prediction deviates from the measurement data at the velocity overshoot.
            However, this error does not appear significant enough to affect the corresponding \gls{MPC} controller.
            The shape of the velocity oscillations also appears to be captured well in the prediction.
            
            \paragraph
            Recall that the prediction is propagated from an initial condition using the given input data only.
            The model does not use state measurements to readjust after the initial condition is taken.
            Therefore an accumulation in prediction error is expected as the prediction horizon increases.
            Because the model prediction matches the shape of the practical testing data so closely,
            it is expected that this model can be used for a practical \gls{MPC} implementation on practical data. 

            % As discussed in Chapter~\ref{chap:control}, 
            % this prediction model can be used in an \gls{MPC} to optimise the control input to actively damp the payload swing angles.
            % It was also noted in Chapter~\ref{chap:control} that the accuracy of the model 
            % has a direct impact on the performance of the controller.
            % Because the model prediction matches the practical testing data so closely,
            % it is expected that this model will 
            
    \FloatBarrier\section{HITL}

        \paragraph
        In Section~\ref{sec:data_driven_sys_id_prac} it was shown that \gls{DMDc} can generate accurate state prediction models from practical flight data.
        It was also shown in Section~\ref{sec:mpc} that the \gls{DMDc} models can be used in an \gls{MPC} for effective swing-damping control.
        A \gls{HITL} simulation can now be used to test the control architecture with the final software running on the actual hardware.
        
        \paragraph
        As described in Section~\ref{sec:exp_design_hitl}, a companion computer runs a \gls{ROS} node which implements the \gls{MPC} algorithm.
        The \gls{MPC} is based on a \gls{DMDc} plant model generated from a \gls{HITL} simulation with the standard \gls{PID} controllers in PX4.
        The companion computer receives state feedback and sends control signals via a \gls{UART} connection to the \gls{FC}.
        The \gls{FC} runs the actual PX4 flight stack firmware and executes the control signals received from the \gls{MPC} node.
        Sensor values are generated by the Gazebo simulator, which is runs on a desktop computer connected to the \gls{FC} via \gls{USB}.
        In this way, we can safely determine whether the practical hardware is suitable for the computational complexity of the control algorithms.
        
        \paragraph
        In this section, the results of different HITL simulations will be shown and discussed.
        Firstly, it will be investigate how the size of the plant model effects the CPU and RAM consumption of the MPC node on the companion computer.
        The effect of the MPC sample time on the CPU consumption will also be investigated.
        Finally, it will be shown that an MPC node (based on a data-driven system identification model) effectively implements swing-damping control in a HITL simulation.

        % ?? Check gls acronyms    
        \FloatBarrier\subsection{Effect of hyperparameters on computational requirements}    

            \input{results/plots/CPU_vs_q.tex}

            \paragraph
            As discussed in Section~\ref{sec:mpc}, the computational complexity of the MPC opimisation problem increases for larger state-space matrices, and the hyper parameter, $q$, determines the size of these matrices.
            Figure~\ref{fig:CPU_vs_q} shows the \%CPU of the companion computer used by the MPC nodes based on plants models with different values of $q$.
            The \%CPU value represents the average percentage of CPU time used by the MPC node while running on the companion computer.
            From Figure~\ref{fig:CPU_vs_q} it is clear that \%CPU increases with increasing values of $q$.
            % This shows that the optimisation problem increases in complexity, since more time is required to solve 
            
            \paragraph
            In Section~\ref{sec:hyperparameters} it was shown that $q = 50$ appears to be near the Pareto optimum with practical flight data and that prediction accuracy does not increase significantly for $q > 50$.
            Figure~\ref{fig:CPU_vs_q} shows that the companion computer runs the MPC node with $q = 50$ and $T_s =$~\SI{0.03}{\second} at \%CPU~$= 82.8\%$.
            The status of the QP solver was also monitored, which showed that the optimisation problem was consistently solved within the given optimisation time for $q = 50$.
            The MPC node achieved stable, swing-damping control with this model.
            However, for $q = 70$ the MPC node used \%CPU~$= 98.7\%$ and the optimisation problem could not be solved fast enough for stable control.
            This resulted in unstable control and the quadrotor-payload system crashed consistently with this MPC node. 

            \input{results/plots/RAM_vs_q.tex}

            \paragraph
            Figure~\ref{fig:RAM_vs_q} shows that the \%RAM also increases for larger values of $q$.
            The \%RAM value represents the maximum percentage of RAM space used by the MPC node while running on the companion computer.
            It is clear that the companion computer has sufficient memory to handle the MPC node memory requirements, since the MPC uses less than 1\% RAM, even with $q = 70$.

        \FloatBarrier\subsection{Effect of sample time on computational requirements}    

            \input{results/plots/CPU_vs_Ts.tex}

            \paragraph
            The sample time of the controller also affects the \%CPU consumption of the MPC node.
            Figure~\ref{fig:CPU_vs_Ts} shows the measured \%CPU of MPC nodes with different sample times using a plant model with $q = 50$. 
            It is clear that \%CPU decreases as $T_s$ increases.
            % In Section~\ref{sec:sample_time}, it was shown that the model prediction accuracy does not change much for different sample times in the range, $20 < q < 40$~ms.
            The standard PID velocity controller in PX4 runs at \SI{50}{\hertz}, which corresponds to $T_s =$~\SI{20}{\milli\second}.
            However, an MPC node with $T_s =$~\SI{20}{\milli\second} struggles to run fast enough on the given companion computer.
            This MPC node resulted in unstable control because the QP problem cannot be solved within the given optimisation time.
            
            \paragraph
            A MPC node with $T_s =$~\SI{40}{\milli\second} runs with a low \%CPU, however it also results in unstable control.
            This is because the controller frequency is too low to provide adequate velocity control for the quadrotor-payload dynamics.
            A MPC node with $T_s =$~\SI{30}{\milli\second} provides stable control of the quadrotor-payload system.
            The controller frequency of \SI{33.33}{\hertz} appears to be fast enough to control the quadrotor-payload dynamics and the QP problem is solved within the given optimisation time.

            % ?? Simulations with latency included
        \FloatBarrier\subsection{Velocity step response}    

            \input{results/plots/HITL_mpc_vel.tex}

            \paragraph
            Figure~\ref{fig:HITL_mpc_vel} plots the velocity responses of the PID and MPC controllers in HITL simulations of the qaudrotor and suspended payload system.
            The MPC controller is based on a system identification model with $q = 50$ and has a sample time of $T_s =$~\SI{30}{\milli\second}.
            It is clear from this plot that the MPC node running on the companion computer provides stable control of the quadrotor payload system and damps the velocity oscillations well.

            \input{results/plots/HITL_mpc_theta.tex}

            \paragraph
            Figure~\ref{fig:HITL_mpc_theta} shows the payload angle data of the PID and MPC controllers during the velocity step response.
            From this plot it is clearly visible that the MPC controller damps the payload angle well.
            Overall, these plots show that the swing-damping performance shown in simulation in Section~\ref{sec:mpc}, is also achievable with the final controller software running on the actual hardware.

            % ?? Check if all plots degrees not radians

    \FloatBarrier\section{Summary}


}