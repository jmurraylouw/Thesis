
{
\tikzset{external/figure name/.add={control/}{}}

\chapter{Control systems}
\label{chap:control}

    \FloatBarrier\section{Overview of controllers} \label{sec:controller_overview}

        \begin{table}[!h]
            \renewcommand{\arraystretch}{1.1}
            \centering
            \caption{Summary of the system identification techniques paired with the active damping controllers.}
            \begin{tabularx}{0.75\linewidth}{@{}lll@{}}
                \toprule
                \multicolumn{2}{c}{\textbf{System identification}}   & \textbf{Controller} \\
                \cmidrule(lr){1-2}
                Category    & Algorithm                     & \\
                \midrule
                White-box   & RLS mass estimator, and       & \gls{LQR} \\
                            & FFT cable length estimator    & \\
                Black-box   & DMDc, or                      & \gls{MPC} \\
                            & HAVOK                         & \\
                \bottomrule
            \end{tabularx}
            \label{tbl:controller_summary}
        \end{table}
    

    \FloatBarrier\section{Cascaded PID}

        Control system design
        Slower for less swing angles

    \FloatBarrier\section{LQR} \label{sec:lqr}

        Anton and Francois stuff

    \FloatBarrier\section{MPC} \label{sec:mpc}

        MATLAB
        QP solver
        C++ generation

    \FloatBarrier\section{Implentation and results}

        \paragraph
        After the system identification phase, active swing damping control can be applied
        to the multirotor and payload system.
        The control architectures are summarised in Table~\ref{tbl:controller_summary} 
        by pairing the system identification techniques along with the appropriate controllers.
        It was firstly shown in Chapter~\ref{chap:system_id} that the system identifcation techniques worked in simulation.
        % Emphasise that control is now applied in a full \gls{SITL} simulation.
        
        \FloatBarrier\subsection{Simple suspended payload} \label{sec:simple_payload_control}

            \paragraph
            The modelling assumptions of the white-box model discussed in Chapter~\ref{chap:modelling} 
            defines a point-mass suspended with a rigid cable which is attached to the \gls{CoM} of the multirotor.
            This is a simplisitic suspended payload model but represents the dynamics of many practical payloads well.
            In this section, the simulated payload model complies will all these assumptions.
            The simulation model used in this section was verified with practical data in Section~\ref{sec:model_verification}.
            This is also the payload model used for simulations with an \gls{LQR} controller by \cite{Erasmus2020} and \cite{Slabber2020}

            \input{control/plots/compare_control_vel.tex}

            \paragraph
            From simulation results, it appears that both the \gls{MPC} and \gls{LQR} effectively damp the payload oscillations while controlling the velocity of the multirotor.
            Figure~\ref{fig:compare_control_vel} shows the velocity step responces of the MPC, \gls{LQR} and PID controllers for a multirotor with a suspended payload.
            From Figure~\ref{fig:compare_control_vel} it is clear that both the \gls{LQR} and \gls{MPC} controllers actively damp the velocity oscillation caused by the swinging payload.
            The \gls{PID} controller does not consider the payload angle, hence the oscillations are not damped as strongly.

            \paragraph
            For the \gls{MPC} and LQR, the respective models were first generated in the training phase of the simulation.
            Thereafter, the \gls{MPC} and \gls{LQR} were manually and iteratively tuned to produce a step response with a similar response time and overshoot.
            The PID response shown uses the same controller gains used in the training phase.

            % MPC:
            % vel weight = 2;
            % theta weight = 0;
            % dtheta weight = 10; 
            % mv weight = 1;
            % mvrate weight = 5;
            % Ty = 5;
            % Tu = 3;

            % LQR:
            % LQR.Q = diag([0.3 10 0 100]); 
            % LQR.R = 8

            \input{control/plots/compare_control_theta.tex}

            \paragraph
            Figure~\ref{fig:compare_control_theta} shows the payload angle data of the velocity step response.
            Both the \gls{MPC} and \gls{LQR} damp the payload angle well and the osciilations cease after only two or three swings.
            In this case, the \gls{MPC} response results in a smaller initial swing angle, however, this is dependant on the specific tuning of each controller.
            The \gls{LQR} can also be tuned to produce a similar swing angle.

            \input{control/plots/compare_control_acc_sp.tex}

            \paragraph
            Figure~\ref{fig:compare_control_acc_sp} shows the acceleration setpoint commanded by the two controllers for this step response.
            This is probably due to the inherant similarity between the controller implementations as discussed in Section~\ref{sec:mpc}.
            The similarity in the acceleration setpoint responses also show that the energy expended in a velocity steps are roughly equal for these two controller implementations.
            However, this is also highly dependant on the weightings used in optimastion problem of both controllers.
            Both controllers also produce a non-zero steady-state setpoint as expected, which is required to counter areodynamic drag.

        \FloatBarrier\subsection{Different payload parameters}

            \paragraph
            The system identification and control implementations are required to perform well with different unknown payload parameters.
            Therefore, numerous flights with a range of different payload were simulated, the respective models were trained and the controllers were implemented.
            Figure~\ref{fig:compare_control_vel_l1} and Figure~\ref{fig:compare_control_vel_l05} show velocity step responces with \gls{LQR} and \gls{MPC} implentations with two payloads flights.
            Both the parameter estimation with \gls{LQR} implementation, and the DMDc with \gls{MPC} implementation, handle flights with different cable lengths and payload masses well.
            In each flight, \gls{LQR} and \gls{MPC} damp the payload oscillations and control the multirotor velocity well.
  
            \input{control/plots/compare_control_vel_l-1.0_mp-0.2.tex} % subfigure

            \input{control/plots/compare_control_vel_l-0.5_mp-0.1.tex} % subfigure
                        
            \paragraph
            The controllers were not specifically tuned for each simulation.
            Instead, the same controller parameters were used for these simulations as for the simulations in Section~\ref{sec:simple_payload_control}.
            This shows that each control architecture is adaptibile to different payload parameters without manual intervention.

        \FloatBarrier\subsection{Variation of other system parameters}

            \paragraph
            The control architectures have been shown to be adaptable to variationd in the payload parameters.
            However, changing other system parameters may affect the performance of the different controllers. 
            As mentioned in Chapter~\ref{chap:system_id}, a disadvantage of the white-box system identification approach used by the LQR,
            is that parameter estimation techniques need to be manually designed for each unknown parameter.
            In the specific implementation, the LQR model assumes that the multirotor mass is known.
            Hence, changing the mass of the multirotor is detrimental to the accuracy of plant model and therefore affects the LQR performance.
            In contrast, the data-driven system identification method for the MPC plant model does not rely on such modelling assumptions.
            
            \begin{figure}
                \captionsetup[subfigure]{justification=centering}
                \centering  
                \input{control/plots/compare_control_vel_mq_changed.tex}
                \input{control/plots/compare_control_theta_mq_changed.tex}
                \caption{Velocity step responses with the multirotor mass decreased by \SI{0.25}{\kilo\gram}
                ($l =$~\SI{0.5}{\meter}, $m_p =$~\SI{0.3}{\kilo\gram})}
                \label{fig:mq_changed} 
            \end{figure}

            \paragraph
            Simulations were performed with an altered multirotor mass to demostrate how the control architectures handle changes in other system parameters.
            Figure~\ref{fig:mq_changed} shows the velocity step responses of the \gls{PID}, \gls{MPC} and \gls{LQR} implementations with an altered multirotor mass.
            For these simulations, the original multirotor mass, $m_Q =$~\SI{0.796}{\kilo\gram}, 
            was decreased by \SI{0.250}{\kilo\gram}, 
            resulting in a new multirotor mass of, $m_Q =$~\SI{0.546}{\kilo\gram}.
            The same system identification processes were naively followed as in the previous sections, without prior knowledge of the change in $m_Q$.
            The same tuned controller parameters were also used.

            \paragraph
            In Figure~\ref{fig:mq_changed} it appears that the LQR results in lower payload oscillations than the PID controller
            but enduces higher frequency oscillations.
            This results in a jittery velocity response with the LQR and is undesirable for a multirotor flight.
            The LQR control performance has degraded because the dynamics of the LQR plant model differs significantly from the actual dynamics. 
            In contrast, the MPC still results in a smooth velocity profile and damps the payload oscillations effectively, as in previous simulations.
            This is expected, since the system identification model used by the MPC included the effect of the changed mass by estimating the entire model without considering indivdual parameters.
            
            \paragraph
            It should be noted that another mass estimator can be implemented to estimate $m_Q$ in a flight stage before the payload is added.
            However, this involves manually redesigning the system identification procedure for each new system parameters that can be changed.
            In these simulations it was shown that changing non-estimated system parameters in the white-box approach can be detrimental to the control performance.
            Unlike the white-box approach, the black-box approach handles changes in different system parameters well without prior knowledge of these parameters.

        \FloatBarrier\subsection{Wind disturbance}

            \paragraph
            For zero steady-state error with a practical system, a controller needs to apply some form of disturbance rejection.
            Practical systems experience unmeasured disturbances and other deviations which are not accounted for by the plant model.
            For example, a mean force applied by wind could prevent zero steady-state tracking error of the multirotor velocity without disturbance rejection.
            As discuseed in Section~\ref{sec:lqr}, an integral state variable was added to the \gls{LQR} plant model for inegral action of the multirotor velocity tracking.
            As discuseed in Section~\ref{sec:mpc}, an unmeasured input was added to the \gls{MPC} plant model with a disturbance estimator to apply integral action to the multirotor velocity.

            \input{control/plots/compare_control_vel_wind_disturbance.tex}

            \paragraph
            Figure~\ref{fig:compare_control_vel_wind_disturbance} shows the responses of the controllers from Section~\ref{sec:simple_payload_control} with a constant wind disturbance starting at \SI{8}{\second}.
            At Time~=~\SI{8}{\second}, a wind speed of \SI{2}{\metre/\second} is applied as an unmeasured step input.
            This mostly affects the multirotor velocity because the wind causes a greater drag force on the multirotor, 
            hence a larger acceleration setpoint is required to maintain a constant velocity.

            \paragraph
            It appears that the MPC shows better disturbance rejection than the LQR when using the controller parameters which were tuned for good performance in Section~\ref{sec:simple_payload_control}.
            This is primarily because the weighting of the integral variable in the LQR optimisation was minimised to reduce overshoot.
            The integral weighting can be increased to improve integral action at the expense of increasing overshoot in the velocity response.

            \input{control/plots/improve_lqr_integrator.tex}

            \paragraph
            Figure~\ref{fig:improve_lqr_integrator} shows the LQR responses with different integral state weightings.
            The other state variable weights are kept constant for each response.
            It is clear that the settling time and disturbance rejection of the LQR improves for larger integral state weighting.
            However, the overshoot increases significantly because of the integrator build up at the start of the response.
            % The overshoot could be decreased by adding a velocity derivative state to the LQR model, but this will involve ex

            \paragraph
            In contrast to the LQR, the \gls{MPC} shows good disturbance rejection while maintaining a low overshoot.
            This is because the disturbance estimator applies integral action which depends on deviation of the actual dynamics from the plant model.
            whereas the LQR applies integral action proportional to the integral of the tracking error.
            Therefore the MPC implementation produces less integrator build up which results in a lower overshoot.

            % Could add effect of bad models. ??

        \FloatBarrier\subsection{Dynamic payload}

            \paragraph
            As discussed in Section~\ref{sec:dynamic_payload}, some payloads have dynamics that differ significantly from a suspended rigid mass.
            In this work, these payloads are refered to as dynamic payloads.
            An example of such a payload is an elongated payload, which can be represented by a double pendulum model. 
            
            \paragraph
            In Section~\ref{sec:dynamic_payload}, the proposed system identification techniques were tested on simulated flight data with such a payload.
            For the white-box system identification approach, it was shown that the white-box model captures the dynamics of the dominant frequency of the oscillating payload but ignores the higher frequency dynamics.
            For the black-box approach, a prediction model was generated from a set of training data.
            This model accurately predicted the multirotor and payload dynamics, including the low and high frequency dynamics, of a set of testing data.

            \input{control/plots/compare_control_vel_dynamic.tex}

            \paragraph
            For the simulations in this section, accurate system identification models were generated as described in Section~\ref{sec:dynamic_payload}, and used in the MPC and LQR controllers.
            Figure~\ref{fig:compare_control_vel_dynamic} shows the reslting controller responses with a dynamic payload.
            It appears that the velocity responses of both the LQR and the MPC are less smooth than with a simiple suspended payload and show small velocity ocsilations.
            
            \input{control/plots/compare_control_theta_dynamic.tex}
            
            \paragraph
            Figure~\ref{fig:compare_control_theta_dynamic} shows the suspension cable angle for a velocity step response.
            It appears that the LQR and MPC damp the payload oscillations with a similar response time.
            However, the superimposed, high frequency oscillations are smaller in the LQR response than in the MPC response.
            The LQR naively damps the payload oscillations because its controller gain is determined from the same dynamical model as for a simple suspended payload.
            Because the angle of the payload relative to the cable is not measured or considered in the LQR plant model, it does not directly damp these high frequency oscillations.
            The MPC should account for the superimposed frequency and provide a smoother response than the LQR, since the black-box model includes the double pendulum dynamics in its prediction model.
            Therefore it is expected that the MPC optimiser determines a smooth trajectory which damps both the low and high frequnecy oscillations. 

            \input{control/plots/mpc_vel_prediction_vs_actual.tex}

            \paragraph
            However, the MPC does not provide a smooth velocity or payload angle response, 
            because the predicted trajectory of the plant model with the optimised input sequence differs significantly from the actual response of the simulated system.
            Figure~\ref{fig:mpc_vel_prediction_vs_actual} shows the predicted velocity of the MPC optimiser, given the velocity setpoint and initial condition at Time~=~\SI{1.1}{\second}.
            The actual simulated response with the MPC controller is also shown in Figure~\ref{fig:mpc_vel_prediction_vs_actual}.
            The optimiser determined a smooth trajectory using the plant model.
            For the first part of the velocity response, the model prediction matches the actual response well.
            However, after Time~=~\SI{3.2}{\second}, the predicted dyanmics is noticebly different from the actual response to the optimised input sequence.

            \input{control/plots/mpc_theta_prediction_vs_actual.tex}

            \paragraph
            Figure~\ref{fig:mpc_theta_prediction_vs_actual} shows the predicted and actual payload angle response for the same simulation at the same time-step.
            The MPC optimiser determined a smooth trajectory for the payload angle, but the actual response differs significantly from this trajectory.
            Even though the black-box model predictions accuratly matched the testing data, Figure~\ref{fig:mpc_vel_prediction_vs_actual} and Figure~\ref{fig:mpc_theta_prediction_vs_actual}  
            show that the model is not an accurate approximation of the simulated system for all values of the state and input vectors. 

            \paragraph
            The estimated model provides accurate predictions in the subspace of state and input vectors considered in the training data.
            However, the MPC generates trajectories which are beyond this subspace and the model needs to extrapolate outside of the training subspace.
            The multirotor with a simple suspended payload represents a mildly non-linear system, hence the linear approximation was effective for control with an MPC.
            However, a double pendulum system reveals highly non-linear dynamics with multiple fixed points.
            This system also includes an unmeasured state variable which adds complexity to dynamics.
            
            \paragraph
            From the results in Figure~\ref{fig:mpc_vel_prediction_vs_actual} and Figure~\ref{fig:mpc_theta_prediction_vs_actual}
            it appears that the data-driven linear model results in acceptable control with an MPC.
            However, the actual dynamics do not follow the optimised trajectory of the MPC and the MPC does not outperform the LQR implementation.

            % ?? Add discussion of how it could be improved:
            % Constrain MPC to stay within subspace
            % Adaptive MPC to include larger subspace

    \FloatBarrier\section{Conclusion}
            
            

} % end of tikz set
    